$(function() {
  $('body').prepend('<div id="fb-root"></div>');

   $.ajax({
     url: "//connect.facebook.net/en_US/all.js",
     dataType: 'script',
     cache: true
   });

   window.fbAsyncInit = function() {  
     FB.init({
       appId: "<%= APP_CONFIG['fb_app_id'] %>",
       cookie: true,
       status: true,
       xfbml: true
     });

     function facebook_login() {
       FB.login(function(response) {
         // redirect
         if (response.authResponse) {
           window.location = '/auth/facebook/callback';
         }
       }, { scope: 'email' });
     }
     
     
    $(document).on('click', "#sign_in", function(e) {
       e.preventDefault();
       facebook_login();
     });

     $('#sign_out').click(function(e) {
       FB.getLoginStatus(function(response) {
         if (response.authResponse) {
           FB.logout();
         }

         return true;
       });
     });
   };
  
  var mapOptions = {
    center: new google.maps.LatLng(37.42841, -122.16960),
    zoom: 15,
    mapTypeId: google.maps.MapTypeId.ROADMAP,
    disableDefaultUI: true
  };

  var map = new google.maps.Map(document.getElementById("map_canvas"),
  mapOptions);

  var infowindow = new google.maps.InfoWindow({
    content: "placeholder"
  });
  
  var events = gon.events;
  var numEvents = events.length;
  for (var i = 0; i < numEvents; i++) {
    var event = events[i].event;
    var marker = new google.maps.Marker({
      position: new google.maps.LatLng(event.latitude,	event.longitude),
      map: map,
      title: event.event_title
    });
    // anonymous closure saves the event and marker in the local scope 
    (function(marker, event) {
      google.maps.event.addListener(marker, 'click', function() {
        var contentString = '<div id="content">' +
                              '<p>' + event.event_title + '<a href="/event_detail?event=' + event.id + '"> details </a>' +  '</p>' +
                            '</div';
        infowindow.setContent(contentString);
        infowindow.open(map,this);
      });
    })(marker, event);
  }
});